<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
    <title>Average Value</title>
    <link href="style.css" rel="stylesheet" />
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.noisy.min.js"></script>
</head>

<!-- Display average-->
<%
var db1 = new Database("jdbc:mysql://10.100.5.152:3306/Average" , "dinithi", "dinithi");
var db2 = new Database("jdbc:mysql://localhost:3306/PressureSensorsDb" , "root", "root");

<!--Print BAM table-->

var q4  ="SELECT pressure_avg,updated_time FROM pressureSensorAvg;";
var bamAvgs = db2.query(q4);

var q5 = "SELECT COUNT(*) as count2 FROM pressureSensorAvg";
var bamRowCount = db2.query(q5);

print("<table><tr><td>BAM average table</br></br></td><td>CEP average table</br></br></td></tr><tr><td width='50%'><table style='font-size:16px;'><tr style='font-size:20px;' height='35px' valign='middle'><th>Average</th><th>Timestamp</th></tr>");

var bamavg;
var bamtimestamp;

for(var i = 0; i < bamRowCount[0].count2; i++) {
        bamavg=bamAvgs[i].pressure_avg;
	
	bamtimestamp=bamAvgs[i].updated_time;
	var date = new Date(Number(bamtimestamp));
	var formattedTime2= date.toString("MMM dd");

	print("<tr height='35px'><td width='15%'>"+bamavg+"</td width='85%'><td>"+formattedTime2+"</td></tr>");
}
print("</table></td>");


<!--Print CEP table-->

var q1  ="SELECT average,timestamp FROM averageCEP;";
var cepAvgs = db1.query(q1);

var q2 = "SELECT COUNT(*) as count1 FROM averageCEP";
var cepRowCount = db1.query(q2);

print("<td width='50%'><table style='font-size:16px;' border='1' style='padding: 10px 10px 10px 10px'><tr style='font-size:20px;' height='35px' valign='middle'><th>Average</th><th>Timestamp</th></tr>");


for(var i = 0; i < cepRowCount[0].count1; i++) {
        var cepavg=cepAvgs[i].average;

	var ceptimestamp=cepAvgs[i].timestamp;
	var date1 = new Date(Number(ceptimestamp));
	var formattedTime1= date1.toString("MMM dd");

	print("<tr height='35px'><td width='15%'>"+cepavg+"</td width='85%'><td>"+formattedTime1+"</td></tr>");
}
print("</table></td></tr></table>");


var q3= "SELECT average,timestamp FROM averageCEP WHERE "+bamtimestamp+" <= timestamp;";
var cepResults = db1.query(q3);

var q6= "SELECT COUNT(timestamp) as count FROM averageCEP WHERE "+bamtimestamp+" <= timestamp;";
var resultCount = db1.query(q6);


var cepSum=0;

for (var j=0; j<resultCount[0].count; j++){
	cepSum+=cepResults[j].average;
}
var finalSum=bamavg+cepSum;
var finalAvg=finalSum/(Number(resultCount[0].count)+1);

print("<h1>Final result: </h1>"+finalAvg);

%>
</html>
