<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
    <title>Average Value</title>
    <link href="style.css" rel="stylesheet" />
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.noisy.min.js"></script>
</head>

<!-- Display average-->
<%
var db = new Database("jdbc:mysql://localhost:3306/cepdatasource" , "root", "root");


<!--Print CEP table-->

var q4  ="SELECT * FROM avgvalues ORDER BY avg desc limit 10;";
var cepAvgs = db.query(q4);

var q5 = "SELECT COUNT(*) as count1 FROM avgvalues";
var cepRowCount = db.query(q5);

print("<table><tr><td>CEP average table</br></br></td><td>BAM average table</br></br></td></tr><tr><td width='50%'><table style='font-size:16px;' border='1' style='padding: 10px 10px 10px 10px'><tr style='font-size:20px;' height='35px' valign='middle'><th>Average</th><th>Timestamp</th></tr>");

for(var i = 0; i < cepRowCount[0].count1; i++) {
        var cepavg=cepAvgs[i].avg;

	var ceptimestamp=cepAvgs[i].timestamp;
	var date = new Date(Number(ceptimestamp));
	var formattedTime= date.toString("MMM dd");

	print("<tr height='35px'><td width='15%'>"+cepavg+"</td width='85%'><td>"+formattedTime+"</td></tr>");
}
print("</table></td>");

<!--Print BAM table-->

var q4  ="SELECT * FROM bamavgvalues ORDER BY avg desc limit 10;";
var bamAvgs = db.query(q4);

var q5 = "SELECT COUNT(*) as count2 FROM bamavgvalues";
var bamRowCount = db.query(q5);

print("<td width='50%'><table style='font-size:16px;'><tr style='font-size:20px;' height='35px' valign='middle'><th>Average</th><th>Timestamp</th></tr>");

for(var i = 0; i < bamRowCount[0].count2; i++) {
        var bamavg=bamAvgs[i].avg;

	var bamtimestamp=bamAvgs[i].timestamp;
	var date = new Date(Number(bamtimestamp));
	var formattedTime= date.toString("MMM dd");

	print("<tr height='35px'><td width='15%'>"+bamavg+"</td width='85%'><td>"+formattedTime+"</td></tr>");
}
print("</table></td></tr></table>");


var q1= "SELECT * FROM bamavgvalues order by timestamp desc limit 1;";
var q2= "SELECT a.avg,a.timestamp FROM avgvalues as a, bamavgvalues as b WHERE b.timestamp<=a.timestamp;";
var q3= "SELECT COUNT(a.avg) as count FROM avgvalues as a, bamavgvalues as b WHERE b.timestamp<=a.timestamp;";

var bamavg=db.query(q1);
var cepavgs=db.query(q2);
var rowcount=db.query(q3);


var sum=0;
var count=rowcount[0].count;
for(var i = 0; i < count; i++) {
	<!-- print(cepavgs[i].avg+" | " + cepavgs[i].timestamp+"<br/>"); -->
	sum+=cepavgs[i].avg;
}

<!--print("COUNT: "+count+"<br/>");-->

var finalavg= (sum+bamavg[0].avg)/(Number(count)+1);
print(finalavg);
%>
</html>
